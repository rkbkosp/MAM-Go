<!DOCTYPE html>
<html>

<head>
    <title>MAM Admin</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        rel="stylesheet" />

    <style>
        :root {
            /* MD3 Dark Theme Tokens */
            --md-sys-color-surface: #141218;
            --md-sys-color-surface-container: #1D1B20;
            --md-sys-color-surface-container-high: #2B2930;
            --md-sys-color-on-surface: #E6E1E5;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-primary-container: #4F378B;
            --md-sys-color-on-primary-container: #EADDFF;
            --md-sys-color-outline: #938F99;
            --md-sys-color-outline-variant: #49454F;

            --md-elevation-level1: 0 1px 2px rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15);
            --md-elevation-level2: 0 1px 2px rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15);

            --border-radius: 12px;
            --border-radius-sm: 8px;
        }

        body {
            margin: 0;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            font-family: 'Roboto', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Nav Rail / Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--md-sys-color-surface-container);
            padding: 12px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--md-sys-color-outline-variant);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 16px 24px 16px;
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--md-sys-color-primary);
        }

        .fab-extended {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border-radius: 16px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 24px;
            transition: all 0.2s;
            box-shadow: var(--md-elevation-level1);
        }

        .fab-extended:hover {
            box-shadow: var(--md-elevation-level2);
            filter: brightness(1.1);
        }

        .nav-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-item {
            padding: 12px 16px 12px 24px;
            border-radius: 28px;
            cursor: pointer;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
            transition: background 0.2s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .nav-item:hover {
            background-color: rgba(230, 225, 229, 0.08);
            color: var(--md-sys-color-on-surface);
        }

        .nav-item.active {
            background-color: var(--md-sys-color-secondary-container, #4A4458);
            color: var(--md-sys-color-on-secondary-container, #E8DEF8);
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .top-app-bar {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            background-color: var(--md-sys-color-surface);
            font-size: 1.375rem;
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
        }

        .content-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        /* Cards */
        .card {
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--md-elevation-level1);
        }

        h2 {
            margin-top: 0;
            font-weight: 400;
            font-size: 1.5rem;
            margin-bottom: 24px;
        }

        .table-container {
            border: 1px solid var(--md-sys-color-outline-variant);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
            margin-top: 24px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: rgba(208, 188, 255, 0.08);
            text-align: left;
            padding: 16px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
        }

        td {
            padding: 16px;
            border-top: 1px solid var(--md-sys-color-outline-variant);
            color: var(--md-sys-color-on-surface-variant);
        }

        tr:hover td {
            background-color: rgba(255, 255, 255, 0.02);
            color: var(--md-sys-color-on-surface);
        }

        /* Inputs */
        .md-field {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .md-field label {
            font-size: 0.75rem;
            color: var(--md-sys-color-primary);
            font-weight: 500;
        }

        .md-input {
            background: transparent;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: 4px;
            padding: 12px 16px;
            color: var(--md-sys-color-on-surface);
            font-size: 1rem;
            font-family: inherit;
        }

        .md-input:focus {
            outline: 2px solid var(--md-sys-color-primary);
            border-color: transparent;
        }

        .md-input::file-selector-button {
            display: none;
        }

        /* Buttons */
        .btn {
            height: 40px;
            border-radius: 20px;
            padding: 0 24px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .btn-filled:hover {
            box-shadow: var(--md-elevation-level1);
            filter: brightness(0.95);
        }

        .btn-tonal {
            background-color: var(--md-sys-color-secondary-container, #4A4458);
            color: var(--md-sys-color-on-secondary-container, #E8DEF8);
        }

        .btn-text {
            background: transparent;
            color: var(--md-sys-color-primary);
            padding: 0 12px;
        }

        .btn-text:hover {
            background-color: rgba(208, 188, 255, 0.08);
        }

        /* Dialog Overlay */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .dialog {
            background: var(--md-sys-color-surface-container-high);
            padding: 24px;
            border-radius: 28px;
            width: 400px;
            box-shadow: var(--md-elevation-level2);
        }

        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 24px;
        }

        .icon {
            font-size: 20px;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="brand">
            <span class="material-symbols-outlined">movie</span>
            <span>私有媒体库</span>
        </div>

        <button class="fab-extended" onclick="showDialog('dialog-create-project')">
            <span class="material-symbols-outlined">add</span>
            新建项目
        </button>

        <div class="nav-list" id="projectList">
            <!-- JS Loaded -->
        </div>
    </div>

    <div class="main">
        <div class="top-app-bar" id="appBarTitle">仪表盘</div>
        <div class="content-area" id="mainContent">
            <div style="text-align: center; margin-top: 100px; color: var(--md-sys-color-outline);">
                <span class="material-symbols-outlined"
                    style="font-size: 48px; margin-bottom: 16px;">video_library</span>
                <p>请选择一个项目以管理内容。</p>
            </div>
        </div>
    </div>

    <!-- Modal: Create Project -->
    <div id="dialog-create-project" class="dialog-overlay" style="display:none;">
        <div class="dialog">
            <h2 style="font-size: 1.5rem; margin-bottom: 16px;">新建项目</h2>
            <div class="md-field">
                <label>项目名称</label>
                <input type="text" class="md-input" id="newProjectName" placeholder="例如：2024_Commercial_Nike">
            </div>
            <div class="dialog-actions">
                <button class="btn btn-text" onclick="closeDialog('dialog-create-project')">取消</button>
                <button class="btn btn-filled" onclick="submitCreateProject()">创建</button>
            </div>
        </div>
    </div>

    <!-- Modal: Upload -->
    <div id="dialog-upload" class="dialog-overlay" style="display:none;">
        <div class="dialog">
            <h2 style="font-size: 1.5rem; format-bottom: 16px;">上传媒体</h2>
            <div class="md-field">
                <label>版本标签</label>
                <input type="text" class="md-input" id="upVersion" placeholder="例如：Cut 1">
            </div>
            <div class="md-field">
                <label>备注</label>
                <input type="text" class="md-input" id="upNote" placeholder="备注信息...">
            </div>
            <div class="md-field">
                <label>视频文件</label>
                <input type="file" class="md-input" id="upFile">
            </div>

            <div id="uploadProgress"
                style="display:none; color: var(--md-sys-color-primary); margin: 10px 0; font-size: 0.9em;">
                上传中... <span id="upPercent">0%</span>
            </div>

            <div class="dialog-actions">
                <button class="btn btn-text" onclick="closeDialog('dialog-upload')">取消</button>
                <button class="btn btn-filled" onclick="submitUpload()">上传</button>
            </div>
        </div>
    </div>

    <!-- Templates for View -->
    <template id="tpl-project-detail">
        <div style="max-width: 1000px; margin: 0 auto;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="margin:0;">设置与操作</h2>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-filled" onclick="openUploadDialog()">
                            <span class="material-symbols-outlined icon">upload</span> 上传
                        </button>
                        <button class="btn btn-tonal" onclick="shareProject()">
                            <span class="material-symbols-outlined icon">share</span> 分享样片
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>版本</th>
                                <th>备注</th>
                                <th>创建时间</th>
                                <th>分享</th>
                            </tr>
                        </thead>
                        <tbody id="videoListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>

    <script>
        let currentProjectID = null;

        // init
        loadProjects();

        function showDialog(id) { document.getElementById(id).style.display = 'flex'; }
        function closeDialog(id) { document.getElementById(id).style.display = 'none'; }

        // API Calls similar to previous, just adapted to new UI
        async function loadProjects() {
            const res = await fetch('/admin/projects');
            const projects = await res.json();
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            projects.forEach(p => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.innerText = p.name;
                div.onclick = () => {
                    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                    div.classList.add('active');
                    loadProjectDetail(p);
                };
                if (currentProjectID == p.id) div.classList.add('active');
                list.appendChild(div);
            });
        }

        async function submitCreateProject() {
            const name = document.getElementById('newProjectName').value;
            if (!name) return;
            const form = new FormData();
            form.append('name', name);
            await fetch('/admin/projects', { method: 'POST', body: form });
            closeDialog('dialog-create-project');
            loadProjects();
            document.getElementById('newProjectName').value = '';
        }

        async function loadProjectDetail(p) {
            currentProjectID = p.id;
            document.getElementById('appBarTitle').innerText = p.name;

            const res = await fetch('/admin/projects/' + p.id);
            const data = await res.json();

            const tpl = document.getElementById('tpl-project-detail');
            const main = document.getElementById('mainContent');
            main.innerHTML = '';
            main.appendChild(tpl.content.cloneNode(true));

            const tbody = document.getElementById('videoListBody');
            data.videos.forEach(v => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td><span style="font-weight:500; color:white;">${v.version_label}</span></td>
                <td>${v.note || '-'}</td>
                <td>${new Date(v.created_at).toLocaleDateString()}</td>
                <td style="display:flex; gap:8px;">
                     <button class="btn btn-text" onclick="shareVideo(${v.id}, 'reviewer')" title="Review Link">
                        <span class="material-symbols-outlined icon">rate_review</span>
                     </button>
                     <button class="btn btn-text" onclick="shareVideo(${v.id}, 'viewer')" title="View Link">
                        <span class="material-symbols-outlined icon">visibility</span>
                     </button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        }

        function openUploadDialog() {
            if (!currentProjectID) return;
            showDialog('dialog-upload');
        }

        function submitUpload() {
            const file = document.getElementById('upFile').files[0];
            const ver = document.getElementById('upVersion').value;
            const note = document.getElementById('upNote').value;
            if (!file) return alert("请选择文件");

            const data = new FormData();
            data.append('file', file);
            data.append('project_id', currentProjectID);
            data.append('version_label', ver);
            data.append('note', note);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/admin/upload', true);
            xhr.upload.onprogress = e => {
                if (e.lengthComputable) {
                    const p = Math.round((e.loaded / e.total) * 100);
                    document.getElementById('uploadProgress').style.display = 'block';
                    document.getElementById('upPercent').innerText = p + '%';
                }
            };
            xhr.onload = () => {
                if (xhr.status === 200) {
                    closeDialog('dialog-upload');
                    document.getElementById('uploadProgress').style.display = 'none';
                    loadProjectDetail({ id: currentProjectID, name: document.getElementById('appBarTitle').innerText });
                } else {
                    alert("错误: " + xhr.responseText);
                }
            };
            xhr.send(data);
        }

        async function shareVideo(vid, role) {
            const form = new FormData();
            form.append('target_id', vid);
            form.append('type', 'demo');
            form.append('role', role);
            const res = await fetch('/admin/tokens', { method: 'POST', body: form });
            const data = await res.json();
            const link = window.location.protocol + "//" + window.location.host + data.link;
            prompt(`分享 ${role} 链接:`, link);
        }

        async function shareProject() {
            const form = new FormData();
            form.append('target_id', currentProjectID);
            form.append('type', 'dailies');
            form.append('role', 'viewer');
            const res = await fetch('/admin/tokens', { method: 'POST', body: form });
            const data = await res.json();
            const link = window.location.protocol + "//" + window.location.host + data.link;
            prompt("分享样片链接:", link);
        }
    </script>
</body>

</html>